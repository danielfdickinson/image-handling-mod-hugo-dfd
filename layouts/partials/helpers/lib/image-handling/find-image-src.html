{{- $destination := .src -}}
{{- $curPage := .page -}}
{{- $relativeURL := .getRelative -}}
{{- $ignoreBundleAssets := .ignoreBundleAssets -}}
{{- $ignoreSiteAssets := .ignoreSiteAssets -}}
{{- $alt := .alt -}}
{{- $title := .title -}}
{{- $external := false -}}
{{- $finalDestination := "" -}}
{{- $path := "" -}}
{{- $imageResource := $curPage.Scratch.Get "non-existent-scratch" -}}
{{- with urls.Parse $destination -}}
    {{- if or .Host .Scheme -}}
        {{- $external = true -}}
    {{- end -}}
    {{- $path = .Path -}}
{{- else -}}
    {{- errorf printf "Unable to parse image src '%s'" $destination -}}
{{- end -}}
{{- if and $path (not $external) -}}
    {{- /* Prefer page bundle assets unless we are ignoring page bundles */ -}}
    {{- if ne $ignoreBundleAssets true -}}
        {{- $imageResources := $curPage.Resources.ByType "image" -}}
        {{- $imageResource = $imageResources.GetMatch (printf "*%s*" $path) -}}
    {{- end -}}
    {{- /* Next prefer assets from 'assets' directory */ -}}
    {{- if and (not $imageResource) (ne $ignoreSiteAssets true) -}}
        {{- $imageResource = resources.Get $path -}}
    {{- end -}}
    {{- /* Finally (for local images), try the 'static' directory (not a resource so no Hugo Pipes) */ -}}
    {{- if not $imageResource -}}
        {{- $finalDestination = partial "helpers/lib/image-handling/get-static-image" (dict "destination" $path "getRelative" false) -}}
    {{- else -}}
        {{- /* For images resources, get the resulting link to the image */ -}}
        {{- $finalDestination = partial "helpers/lib/image-handling/get-resource-link" (dict "imageResource" $imageResource "getRelative" false ) -}}
    {{- end -}}
    {{- if not $finalDestination -}}
        {{- if $curPage.File -}}
            {{- errorf (printf "Image %s is missing and not external for page %s" $destination $curPage.File.Path) -}}
        {{- else -}}
            {{- errorf (printf "Image %s is missing and not external for page %s" $destination $curPage.Title) -}}
        {{- end -}}
    {{- end -}}
{{- else if $external -}}{{- /* Use external URLs verbatim (not as a resource so no Hugo Pipes; we don't use 0.92.x only functionality, yet) */ -}}
    {{- $finalDestination = $destination -}}
{{- end -}}
{{- $image := (dict "imageResource" $imageResource "link" $finalDestination "url" $finalDestination) -}}
{{- if $alt -}}
    {{ $image = $image | merge (dict "alt" $alt) -}}
{{- end -}}    
{{- if $title -}}
    {{ $image = $image | merge (dict "title" $title) -}}
{{- end -}}    
{{- if $finalDestination -}}
    {{- $secUrl := $finalDestination | absURL -}}
    {{- with urls.Parse $secUrl -}}
        {{- if eq .Scheme "https" -}}
           {{- $image = $image | merge (dict "secure_url" $secUrl) -}}
        {{- end -}}
    {{- end -}}
{{- end -}}
{{- if not (or $image.imageResource $image.link) -}}
    {{- $image = $curPage.Scratch.Get "non-existent-scratch" -}}
{{- end -}}
{{- return $image -}}