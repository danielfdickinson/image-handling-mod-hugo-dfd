{{- $finalImages := (slice) -}}
{{- $inPage := .page -}}
{{- $inImages := .images -}}
{{- $microformatWidth := $inPage.Params.microformatWidth | default $inPage.Site.Params.microformatWidth | default 1200 | int -}}
{{- $microformatHeight := $inPage.Params.microformatHeight | default $inPage.Site.Params.microformatHeight | default 630 | int -}}
{{- $microformatSizingMethod := $inPage.Params.microformatSizingMethod | default $inPage.Site.Params.microformatSizingMethod | default "Fill" -}}
{{- with $inImages -}}
    {{- if reflect.IsMap . -}}
        {{- $image := .imageResource -}}
        {{- $link := .link -}}
        {{- $alt := .alt -}}
        {{- if $image -}}{{- /* If we have an image resource, process the image */ -}}
            {{ $imageMap := partial "helpers/lib/image-handling/generate-images" (dict "page" $inPage "singleSize" true "image" . "width" $microformatWidth "height" $microformatHeight "convertMethod" $microformatSizingMethod "getRelative" false) -}}
            {{ $finalImages = $finalImages | append (dict "image" $imageMap.fullImage "link" $imageMap.finalSrc "width" $imageMap.width "height" $imageMap.height "alt" $alt) -}}
        {{- else -}}{{- /* If we don't have an image resource, just keep the map (which has the .link for the image) */ -}}
            {{- $finalImages = $finalImages | append . -}}
        {{- end -}}
    {{- else if reflect.IsSlice . -}}
        {{- range . -}}
            {{- if reflect.IsMap . -}}
                {{- $image := .imageResource -}}
                {{- $link := .link -}}
                {{- $alt := .alt -}}
                {{- if $image -}}{{- /* If we have an image resource, process the image */ -}}
                    {{ $imageMap := partial "helpers/lib/image-handling/generate-images" (dict "page" $inPage "singleSize" true "image" . "width" $microformatWidth "height" $microformatHeight "convertMethod" $microformatSizingMethod "getRelative" false) -}}
                    {{ $finalImages = $finalImages | append (dict "image" $imageMap.fullImage "link" $imageMap.finalSrc "url" $imageMap.finalSrc "width" $imageMap.width "height" $imageMap.height "alt" $alt) -}}
                {{- else -}}{{- /* If we don't have an image resource, just keep the map (which has the .link for the image) */ -}}
                    {{- $finalImages = $finalImages | append . -}}
                {{- end -}}
            {{- else -}}
                {{- $finalImages = $finalImages | append . -}}
            {{- end -}}
        {{- end -}}
    {{- else -}}
        {{- $finalImages = $finalImages | append . -}}
    {{- end -}}
{{- end -}}
{{- return $finalImages -}}
